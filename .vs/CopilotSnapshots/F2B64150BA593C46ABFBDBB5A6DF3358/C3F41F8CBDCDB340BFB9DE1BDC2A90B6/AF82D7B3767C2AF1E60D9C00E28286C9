import tkinter as tk
from tkinter import ttk
from tkinter import filedialog, messagebox
import csv
from LogikaKSZ import Dolgozo_KSZ_Osztaly, rendezes_ksz_fv


class Applikacio:
    def __init__(self, root_ablak):
        self.app = root_ablak
        self.app.title("KSZ Projekt - Adatrendező")
        self.app.geometry("400x400")

        self.dolgozok_lista = []

        self.frame = ttk.Frame(self.app, padding="10")
        self.frame.pack(fill=tk.BOTH, expand=True)

        self.lista_cim = ttk.Label(self.frame, text="Dolgozók:")
        self.lista_cim.pack()

        self.listbox = tk.Listbox(self.frame, height=10)
        self.listbox.pack(fill=tk.X, expand=True, pady=5)

        self.btn_frame = ttk.Frame(self.frame)
        self.btn_frame.pack(fill=tk.X)

        self.btn_rendez_nev = ttk.Button(self.btn_frame, text="Rendezés (Név)", command=self.rendez_nev)
        self.btn_rendez_nev.pack(side=tk.LEFT, expand=True, fill=tk.X, padx=2)

        self.btn_rendez_kor = ttk.Button(self.btn_frame, text="Rendezés (Kor)", command=self.rendez_kor)
        self.btn_rendez_kor.pack(side=tk.LEFT, expand=True, fill=tk.X, padx=2)

        self.menu = tk.Menu(self.app)
        self.app.config(menu=self.menu)
        self.file_menu = tk.Menu(self.menu, tearoff=0)

        self.menu.add_cascade(label="Fájl", menu=self.file_menu)
        self.file_menu.add_command(label="Adatok betöltése (CSV)", command=self.betolt_csv)
        self.file_menu.add_separator()
        self.file_menu.add_command(label="Kilépés", command=self.app.destroy)

        self.betolt_alap_adatok()
        self.frissit_lista()

    def betolt_alap_adatok(self):
        self.dolgozok_lista = [
            Dolgozo_KSZ_Osztaly("Nagy János", 45),
            Dolgozo_KSZ_Osztaly("Kiss Mária", 28),
            Dolgozo_KSZ_Osztaly("Tóth Béla", 51),
            Dolgozo_KSZ_Osztaly("Szabó Elemér", 33)
        ]

    def frissit_lista(self):
        self.listbox.delete(0, tk.END)
        for dolgozo in self.dolgozok_lista:
            self.listbox.insert(tk.END, str(dolgozo))

    def rendez_nev(self):
        self.dolgozok_lista = rendezes_ksz_fv(self.dolgozok_lista, 'nev')
        self.frissit_lista()

    def rendez_kor(self):
        self.dolgozok_lista = rendezes_ksz_fv(self.dolgozok_lista, 'kor')
        self.frissit_lista()

    def betolt_csv(self):
        fajlnev = filedialog.askopenfilename(
            title="CSV fájl megnyitása",
            filetypes=(("CSV fájlok", "*.csv"), ("Minden fájl", "*.*"))
        )
        if not fajlnev:
            return

        # Próbáljuk meg különböző kódolásokkal
        encodings = ['utf-8', 'latin1', 'latin2', 'cp1250', 'iso-8859-2']
        
        for encoding in encodings:
            try:
                with open(fajlnev, mode='r', encoding=encoding) as f:
                    # Először ellenőrizzük, hogy van-e tartalom a fájlban
                    tartalom = f.read()
                    if not tartalom.strip():
                        messagebox.showerror("Hiba", "A CSV fájl üres!")
                        return
 
                    # Ha van tartalom, újra megnyitjuk a fájlt CSV olvasáshoz
                    f.seek(0)
                    csv_olvaso = csv.reader(f, delimiter=';')
                    uj_lista = []
                    
                    # Az első sor a fejléc
                    try:
                        fejlec = next(csv_olvaso)
                        if len(fejlec) != 2:
                            continue  # Próbáljuk a következő kódolással, ha a fejléc nem megfelelő
                    except StopIteration:
                        continue
                 
                   # Sorok feldolgozása
                    for sor in csv_olvaso:
                        if len(sor) == 2:
                            try:
                                kor = int(sor[1])
                                if kor < 0 or kor > 150:  # Életkor ellenőrzése
                                    messagebox.showwarning("Figyelmeztetés", f"Érvénytelen életkor: {kor}")
                                    continue
                                uj_lista.append(Dolgozo_KSZ_Osztaly(sor[0], kor))
                            except ValueError:
                                    messagebox.showwarning("Figyelmeztetés", f"Érvénytelen kor érték a következő sorban: {sor}")
                               continue
               
                    if uj_lista:
                        self.dolgozok_lista = uj_lista
                        self.frissit_lista()
                        self.mentsd_adatbazisba(fajlnev)
                        messagebox.showinfo("Siker", f"{len(uj_lista)} dolgozó sikeresen betöltve!")
                        return
                    else:
                         continue  # Ha nem sikerült adatokat beolvasni, próbáljuk a következő kódolást

            except UnicodeDecodeError:
                 continue  # Próbáljuk a következő kódolást
            except Exception as e:
                messagebox.showerror("Hiba", f"Hiba történt a fájl olvasása közben:\n{str(e)}")
                return

        messagebox.showerror("Hiba", 
            "Nem sikerült a fájl beolvasása egyik támogatott kódolással sem.\n" +
  "Kérem ellenőrizze, hogy a CSV fájl megfelelő formátumú-e:\n" +
            "- A fájlnak pontosvesszővel (;) elválasztott értékeket kell tartalmaznia\n" +
            "- Az első sornak fejlécnek kell lennie\n" +
"- Minden sornak két oszlopot kell tartalmaznia (név és kor)\n" +
      "- A kor értékének számnak kell lennie")

    def mentsd_adatbazisba(self, eredeti_fajlnev):
        uj_fajlnev = eredeti_fajlnev.replace(".csv", "_mentes.csv")

        try:
            with open(uj_fajlnev, mode='w', encoding='utf-8', newline='') as f:
                csv_iro = csv.writer(f, delimiter=';')

                csv_iro.writerow(["Nev", "Kor"])
                for dolgozo in self.dolgozok_lista:
                    csv_iro.writerow([dolgozo.nev, dolgozo.kor])
        except Exception as e:
            messagebox.showerror("Hiba", f"Hiba a CSV írása közben: {str(e)}")


if __name__ == "__main__":
    root = tk.Tk()
    app = Applikacio(root_ablak=root)
    root.mainloop()